<div class="card">
  <div class="card-body">
    <div class="d-flex align-items-center mb-4">
      <% 
        const fotoSrc = anagrafica.foto || defaultPhoto;
      %>
      <form id="photo-form"
            action="/anagrafica/update-photo/<%= anagrafica.id %>"
            method="POST"
            enctype="multipart/form-data"
            class="d-flex align-items-center">
        <div class="position-relative me-3">
          <img id="profile-img"
               src="<%= fotoSrc %>"
               alt="Foto di <%= anagrafica.nome %> <%= anagrafica.cognome %>"
               class="img-thumbnail"
               style="width:100px; height:100px; object-fit:cover;">
          <input id="foto-input"
                 type="file"
                 name="foto"
                 accept="image/*"
                 class="form-control form-control-sm d-none"
                 style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0;">
        </div>
        <div>
          <h5 class="mb-1"><%= anagrafica.nome %>¬†<%= anagrafica.cognome %></h5>
          <button id="btn-edit-photo" type="button" class="btn btn-sm btn-outline-primary mb-2">
            Modifica foto
          </button>
          <button id="btn-save-photo" type="submit" class="btn btn-sm btn-success mb-2 d-none">
            üíæ Salva
          </button>
          <button id="btn-cancel-photo" type="button" class="btn btn-sm btn-secondary mb-2 d-none">
            ‚Ü©Ô∏è Annulla
          </button>
        </div>
      </form>
    </div>

    <% 
      const dob = anagrafica.data_nascita;
      const dobStr = (typeof dob === 'string' ? dob.slice(0,10)
                      : dob instanceof Date ? dob.toISOString().split('T')[0]
                      : '‚Äî');
    %>
    <p><strong>Data di nascita:</strong> <%= dobStr %></p>
    <p><strong>Comune:</strong> <%= anagrafica.luogo_nascita %></p>
    <p><strong>Cellulare:</strong> <%= anagrafica.cellulare %></p>
    <p><strong>Note:</strong> <%= anagrafica.note || '‚Äî' %></p>

    <hr>

<!-- ...prima del tag <hr>-->

<div class="mb-3 d-flex align-items-center">
  <label for="infortunio-switch" class="me-3"><strong>Infortunio:</strong></label>
  <div class="form-check form-switch">
    <input class="form-check-input" type="checkbox" id="infortunio-switch"
           <%= anagrafica.infortunio ? 'checked' : '' %>>
  </div>
</div>

<div id="rientro-group" class="mb-3 <%= anagrafica.infortunio ? '' : 'd-none' %>">
  <label for="data-rientro" class="form-label">Data di rientro (opzionale):</label>
  <input type="date" id="data-rientro"
         class="form-control w-auto d-inline-block"
         value="<%= anagrafica.data_rientro ? anagrafica.data_rientro.slice(0,10) : '' %>">
</div>

<div class="mb-4">
  <button id="btn-save-infortunio" class="btn btn-sm btn-success d-none">
    üíæ Salva infortunio
  </button>
  <button id="btn-edit-infortunio" class="btn btn-sm btn-warning d-none ms-2">
    ‚úèÔ∏è Modifica infortunio
  </button>
  <button id="btn-cancel-infortunio" class="btn btn-sm btn-secondary d-none ms-2">
    ‚Ü©Ô∏è Annulla
  </button>
</div>

<script>
  (function(){
    const sw      = document.getElementById('infortunio-switch');
    const grp     = document.getElementById('rientro-group');
    const inp     = document.getElementById('data-rientro');
    const btnSave = document.getElementById('btn-save-infortunio');
    const btnEdit = document.getElementById('btn-edit-infortunio');
    const btnCancel = document.getElementById('btn-cancel-infortunio');
    const id      = <%= anagrafica.id %>;

    // 1) Cambio switch ‚Üí mostra data & Salva
    sw.addEventListener('change', () => {
      grp.classList.toggle('d-none', !sw.checked);
      btnSave.classList.remove('d-none');
      btnEdit.classList.add('d-none');
      btnCancel.classList.add('d-none');
    });

    // 2) Click Salva ‚Üí POST AJAX
    btnSave.addEventListener('click', async () => {
      const payload = { 
        infortunio: sw.checked, 
        data_rientro: inp.value || null 
      };
      const res = await fetch(`/anagrafica/${id}/infortunio`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        alert('Errore salvataggio');
        return;
      }
      // dopo salvataggio disabilito e mostro Modifica/Annulla
      sw.disabled = true;
      inp.disabled = true;
      btnSave.classList.add('d-none');
      btnEdit.classList.remove('d-none');
      btnCancel.classList.remove('d-none');
    });

    // 3) Click Modifica ‚Üí riabilita
    btnEdit.addEventListener('click', () => {
      sw.disabled = false;
      inp.disabled = false;
      btnEdit.classList.add('d-none');
      btnCancel.classList.add('d-none');
      btnSave.classList.remove('d-none');
    });

    // 4) Click Annulla ‚Üí ricarica partial
    btnCancel.addEventListener('click', () => {
      fetch(`/fascicoli/${id}`)
        .then(r => r.text())
        .then(html => {
          document.getElementById('fascicolo-detail').innerHTML = html;
        });
    });
  })();
</script>



    <h5>Terapie collegate</h5>
    <% if (therapies.length === 0) { %>
      <p class="text-muted">Nessuna terapia registrata.</p>
    <% } else { %>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th>Data</th>
            <th>Distretto</th>
            <th>Trattamento</th>
            <th>Note</th>
            <th class="text-center">Azioni</th>
          </tr>
        </thead>
        <tbody>
          <% therapies.forEach(tr => { 
               const td = tr.data_trattamento;
               const tdStr = (typeof td === 'string' ? td.slice(0,10)
                              : td instanceof Date ? td.toISOString().split('T')[0]
                              : '');
          %>
            <tr data-id="<%= tr.id %>">
              <td><%= tdStr %></td>
              <td><%= tr.distretto %></td>
              <td><%= tr.trattamento %></td>
              <td><%= tr.note || '‚Äî' %></td>
              <td class="text-center">
                <!-- Allegati -->
                <a href="/terapie/<%= tr.id %>/allegati" 
                   class="btn btn-outline-secondary btn-sm"
                   title="Gestisci allegati">üìé</a>
                <!-- Export PDF -->
                <a href="/fascicoli/<%= anagrafica.id %>/export/<%= tr.id %>"
                   class="btn btn-outline-primary btn-sm ms-1"
                   title="Esporta questo fascicolo + terapia in PDF">üìÑ</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>

    <h6 class="mt-4">Allegati per ogni terapia</h6>
    <% if ((attachments || []).length === 0) { %>
      <p class="text-muted">Nessun allegato caricato.</p>
    <% } else { %>
      <% therapies.forEach(tr => {
           const atts = attachments.filter(a => a.terapia_id === tr.id);
      %>
        <div class="mb-3">
          <strong><%= (typeof tr.data_trattamento === 'string'
                        ? tr.data_trattamento.slice(0,10)
                        : tr.data_trattamento instanceof Date
                          ? tr.data_trattamento.toISOString().split('T')[0]
                          : '') %>:</strong>
          <% atts.forEach(a => { %>
            <a href="<%= a.url %>" target="_blank" class="mx-2">üñºÔ∏è</a>
          <% }) %>
        </div>
      <% }) %>
    <% } %>

    <p>
      <a href="/fascicoli" class="btn btn-secondary btn-sm">
        ‚Üê Torna ai fascicoli
      </a>
    </p>
  </div>
</div>

<script>
  (function(){
    const sw  = document.getElementById('infortunio-switch');
    const grp = document.getElementById('rientro-group');
    const inp = document.getElementById('data-rientro');
    const btnSave  = document.getElementById('btn-save-infortunio');
    const btnEdit  = document.getElementById('btn-edit-infortunio');
    const btnCancel= document.getElementById('btn-cancel-infortunio');

    // Mostra/nasconde la data di rientro
    sw.addEventListener('change', () => {
      grp.classList.toggle('d-none', !sw.checked);
      // se spengo lo switch, resetto campo
      if (!sw.checked) inp.value = '';
      // togglo bottoni
      btnSave.classList.toggle('d-none', !sw.checked);
      btnEdit.classList.toggle('d-none', sw.checked);
    });

    // Salva
    btnSave.addEventListener('click', async () => {
      const id = <%= anagrafica.id %>;
      const payload = new URLSearchParams({
        infortunio: sw.checked,
        data_rientro: inp.value
      });
      const res = await fetch(`/fascicoli/${id}/infortunio`, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: payload
      });
      if (!res.ok) return alert('Errore salvataggio');
      // dopo save, mostro i bottoni Modifica/Annulla
      sw.disabled = true;
      inp.disabled = true;
      btnSave.classList.add('d-none');
      btnEdit.classList.remove('d-none');
      btnCancel.classList.remove('d-none');
    });

    // Modifica: riabilita switch + input
    btnEdit.addEventListener('click', () => {
      sw.disabled = false;
      inp.disabled = false;
      btnEdit.classList.add('d-none');
      btnCancel.classList.add('d-none');
      btnSave.classList.remove('d-none');
    });

    // Annulla: ricarica il partial dal server
    btnCancel.addEventListener('click', () => {
      caricaFascicolo(<%= anagrafica.id %>);
    });
  })();
</script>
