<div class="card">
  <div class="card-body">
    <div class="d-flex align-items-center mb-4">
      <% 
        // URL immagine: se è già l’URL Cloudinary lo uso, altrimenti fallback
        const fotoSrc = anagrafica.foto || defaultPhoto;
      %>
      <img
        src="<%= fotoSrc %>"
        alt="Foto di <%= anagrafica.nome %> <%= anagrafica.cognome %>"
        class="img-thumbnail me-3"
        style="width:100px; height:100px; object-fit:cover;"
        onerror="this.onerror=null;this.src='<%= defaultPhoto %>'"
      >
      <h5 class="mb-0"><%= anagrafica.nome %> <%= anagrafica.cognome %></h5>
    </div>

    <% 
      // Formatta data di nascita come stringa YYYY-MM-DD
      const dobRaw = anagrafica.data_nascita;
      const dobStr = typeof dobRaw === 'string'
        ? dobRaw.slice(0,10)
        : '—';
    %>
    <p><strong>Data di nascita:</strong> <%= dobStr %></p>
    <p><strong>Comune:</strong> <%= anagrafica.luogo_nascita %></p>
    <p><strong>Cellulare:</strong> <%= anagrafica.cellulare %></p>
    <p><strong>Note:</strong> <%= anagrafica.note || '—' %></p>

    <hr>

    <h5>Terapie collegate</h5>
    <% if (therapies.length === 0) { %>
      <p class="text-muted">Nessuna terapia registrata.</p>
    <% } else { %>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th>Data</th>
            <th>Distretto</th>
            <th>Trattamento</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          <% therapies.forEach(tr => {
               const tdRaw = tr.data_trattamento;
               const tdStr = typeof tdRaw === 'string'
                 ? tdRaw.slice(0,10)
                 : '';
          %>
            <tr>
              <td><%= tdStr %></td>
              <td><%= tr.distretto %></td>
              <td><%= tr.trattamento %></td>
              <td><%= tr.note || '—' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>
</div>
