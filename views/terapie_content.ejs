<h3 class="mb-4">Nuova Terapia</h3>

<% if (typeof message !== 'undefined' && message) { %>
  <div class="alert alert-success"><%= message %></div>
<% } %>

<form method="POST" action="/terapie">
  <div class="mb-3">
    <label for="dataTrattamento" class="form-label">Data trattamento</label>
    <input type="date" name="data_trattamento" id="dataTrattamento" class="form-control" required>
  </div>

  <div class="mb-4 d-flex justify-content-center">
    <div class="position-relative" style="max-width: 600px;">
      <img src="/images/uomo_frontal_back.png" class="img-fluid w-100" alt="Corpo umano" id="bodyMap">
      <!-- container per i pallini rossi -->
      <div id="punti-container" class="position-absolute top-0 start-0"></div>
      <div id="distrettoSelected" class="text-center text-primary fw-semibold mt-2"></div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <label for="anagrafica" class="form-label">Anagrafica</label>
      <select name="anagrafica_id" id="anagrafica" class="form-select" required>
        <option value="">Seleziona un'anagrafica</option>
        <% anagrafiche.forEach(a => { %>
          <option value="<%= a.id %>"><%= a.nome %> <%= a.cognome %></option>
        <% }) %>
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label for="distretto" class="form-label">Distretto anatomico</label>
      <select name="distretto_id" id="distretto" class="form-select" required>
        <option value="">Seleziona un distretto</option>
        <% distretti.forEach(d => { %>
          <option value="<%= d.id %>"><%= d.nome %></option>
        <% }) %>
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label for="trattamento" class="form-label">Trattamento</label>
      <select name="trattamento_id" id="trattamento" class="form-select" required>
        <option value="">Seleziona un trattamento</option>
        <% trattamenti.forEach(t => { %>
          <option value="<%= t.id %>"><%= t.nome %></option>
        <% }) %>
      </select>
    </div>
  </div>

  <div class="mb-3">
    <label for="note" class="form-label">Note</label>
    <input type="text" name="note" id="note" class="form-control">
  </div>

  <button type="submit" class="btn btn-success">Salva</button>
</form>

<style>
  /* container debug */
  #punti-container {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 5;
  }

  .punto-rosso {
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: red;
    transform: translate(-50%, -50%);
    cursor: pointer;
    opacity: 0.8;
    pointer-events: auto;
    z-index: 10;
  }

  #distrettoSelected {
    font-size: 1.1rem;
  }

  @media (max-width: 767.98px) {
    #distrettoSelected {
      font-size: 1rem;
      margin-top: 0.5rem;
    }
  }
</style>

<script>
  // dati dal server
  const distretti = <%- JSON.stringify(distretti) %>;

  const img = document.getElementById('bodyMap');
  const container = document.getElementById('punti-container');

  function renderPallini() {
    const natW = img.naturalWidth;
    const natH = img.naturalHeight;
    const dispW = img.clientWidth;
    const dispH = img.clientHeight;

    console.log('nat:', natW, '×', natH, 'disp:', dispW, '×', dispH);

    // rimuovi pallini precedenti
    container.querySelectorAll('.punto-rosso').forEach(p => p.remove());

    distretti.forEach(d => {
      const [x, y] = d.coords.split(',').map(Number);
      const percentX = x / natW * 100;
      const percentY = y / natH * 100;

      const p = document.createElement('div');
      p.className = 'punto-rosso';
      p.style.left = `${percentX}%`;
      p.style.top  = `${percentY}%`;
      p.title           = d.nome;
      p.dataset.distretto = d.nome;

      p.addEventListener('click', e => {
        e.stopPropagation();
        document.getElementById('distrettoSelected').textContent =
          'Distretto selezionato: ' + d.nome;
        const select = document.getElementById('distretto');
        for (let o of select.options) {
          if (o.textContent.trim() === d.nome.trim()) {
            select.value = o.value;
            break;
          }
        }
      });

      container.appendChild(p);
    });
  }

  function syncContainer() {
    console.log('syncContainer: img size', img.clientWidth, img.clientHeight);
    container.style.width  = img.clientWidth + 'px';
    container.style.height = img.clientHeight + 'px';
    renderPallini();
  }

  img.addEventListener('load', syncContainer);
  window.addEventListener('resize', syncContainer);
  if (img.complete) syncContainer();
</script>
