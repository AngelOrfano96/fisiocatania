<h3 class="mb-4">Nuova Terapia</h3>

<% if (typeof message !== 'undefined' && message) { %>
  <div class="alert alert-success"><%= message %></div>
<% } %>

<form method="POST" action="/terapie">
  <div class="mb-3">
    <label for="dataTrattamento" class="form-label">Data trattamento</label>
    <input type="date" name="data_trattamento" id="dataTrattamento" class="form-control" required>
  </div>

  <div class="mb-4 d-flex justify-content-center">
    <div class="position-relative w-100" style="max-width: 600px;">
      <img src="/images/uomo_frontal_back.png" class="img-fluid w-100" alt="Corpo umano" id="bodyMap">
      <div id="punti-container"></div>
      <div id="distrettoSelected" class="text-center text-primary fw-semibold mt-2"></div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <label for="anagrafica" class="form-label">Anagrafica</label>
      <select name="anagrafica_id" id="anagrafica" class="form-select" required>
        <option value="">Seleziona un'anagrafica</option>
        <% anagrafiche.forEach(a => { %>
          <option value="<%= a.id %>"><%= a.nome %> <%= a.cognome %></option>
        <% }) %>
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label for="distretto" class="form-label">Distretto anatomico</label>
      <select name="distretto_id" id="distretto" class="form-select" required>
        <option value="">Seleziona un distretto</option>
        <% distretti.forEach(d => { %>
          <option value="<%= d.id %>"><%= d.nome %></option>
        <% }) %>
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label for="trattamento" class="form-label">Trattamento</label>
      <select name="trattamento_id" id="trattamento" class="form-select" required>
        <option value="">Seleziona un trattamento</option>
        <% trattamenti.forEach(t => { %>
          <option value="<%= t.id %>"><%= t.nome %></option>
        <% }) %>
      </select>
    </div>
  </div>

  <div class="mb-3">
    <label for="note" class="form-label">Note</label>
    <input type="text" name="note" id="note" class="form-control">
  </div>

  <button type="submit" class="btn btn-success">Salva</button>
</form>

<style>
  .punto-rosso {
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: red;
    transform: translate(-50%, -50%);
    cursor: pointer;
    opacity: 0.8;
    z-index: 10;
  }

  area:focus {
    outline: none;
  }

  #distrettoSelected {
    font-size: 1.1rem;
  }

  @media (max-width: 767.98px) {
    #distrettoSelected {
      font-size: 1rem;
      margin-top: 0.5rem;
    }
  }
</style>

<script>
    const distretti = JSON.parse('<%= JSON.stringify(distretti) %>');
  const img = document.getElementById('bodyMap');
  const container = document.querySelector('.position-relative');

  function renderPallini() {
    const imgWidth = img.clientWidth;
    const imgHeight = img.clientHeight;

    // Rimuovi eventuali pallini precedenti
    document.querySelectorAll('.punto-rosso').forEach(p => p.remove());

    distretti.forEach(d => {
      const [x, y] = d.coords.split(',').map(Number);
      const percentX = (x / 540) * 100;  // immagine base: 540x600
      const percentY = (y / 600) * 100;

      const punto = document.createElement('div');
      punto.className = 'punto-rosso';
      punto.style.left = `${percentX}%`;
      punto.style.top = `${percentY}%`;
      punto.title = d.nome;
      punto.dataset.distretto = d.nome;

      punto.addEventListener('click', () => {
        document.getElementById('distrettoSelected').textContent = "Distretto selezionato: " + d.nome;

        const select = document.getElementById('distretto');
        for (let option of select.options) {
          if (option.textContent.trim() === d.nome.trim()) {
            select.value = option.value;
            break;
          }
        }
      });

      container.appendChild(punto);
    });
  }

  // Rendi i pallini reattivi al resize
  window.addEventListener('resize', renderPallini);
  img.addEventListener('load', renderPallini);

  // Se l'immagine è già caricata (cache), disegna subito
  if (img.complete) renderPallini();
</script>
