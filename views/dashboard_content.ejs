<h3>Benvenuto, <%= user %></h3>

<div class="mb-4">
  <label for="period-select" class="form-label me-2">Intervallo:</label>
  <select id="period-select" class="form-select w-auto d-inline-block">
    <option value="week">Ultima settimana</option>
    <option value="month" selected>Ultimo mese</option>
    <option value="year">Ultimo anno</option>
  </select>
</div>

<div class="row gy-4 mb-5">
  <!-- Distretto -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Distretti (terapie)</h5>
        <canvas id="chart-distretti"></canvas>
      </div>
    </div>
  </div>
  <!-- Trattamenti -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Trattamenti</h5>
        <canvas id="chart-trattamenti"></canvas>
      </div>
    </div>
  </div>
  <!-- Operatori -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Operatori</h5>
        <canvas id="chart-operatori"></canvas>
      </div>
    </div>
  </div>
  <!-- Giocatori -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Giocatori</h5>
        <canvas id="chart-giocatori"></canvas>
      </div>
    </div>
  </div>
</div>

<hr>

<h3>Giocatori Disponibili</h3>
<input id="filter-avail" placeholder="Filtra per nome/cognome" class="form-control w-25 mb-2" />
<table id="tbl-disponibili" class="table table-striped">
  <thead>
    <tr>
      <th>Infortunato</th>
      <th>Nome Cognome</th>
    </tr>
  </thead>
  <tbody>
    <% disponibili.forEach(p => { %>
      <tr data-id="<%= p.id %>">
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input switch-inf" type="checkbox"
                   <%= p.infortunio ? 'checked' : '' %> />
          </div>
        </td>
        <td><%= p.nome %> <%= p.cognome %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

<hr>

<h3>Giocatori Non Disponibili</h3>
<input id="filter-unavail" placeholder="Filtra per nome/cognome" class="form-control w-25 mb-2" />
<table id="tbl-nondisponibili" class="table table-striped">
  <thead>
    <tr>
      <th>Infortunato</th>
      <th>Nome Cognome</th>
    </tr>
  </thead>
  <tbody>
    <% nondisponibili.forEach(p => { %>
      <tr data-id="<%= p.id %>">
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input switch-inf" type="checkbox"
                   <%= p.infortunio ? 'checked' : '' %> />
          </div>
        </td>
        <td><%= p.nome %> <%= p.cognome %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

<script>
  $(document).ready(function(){
  const dtAvail = $('#tbl-disponibili').DataTable({
    pageLength: 5,
    lengthChange: false,
    // assicuriamoci che il paging sia sempre visibile
    dom: 'lrtip',
    language: {
      paginate: { previous: '«', next: '»' },
      info:     'Pagina _PAGE_ di _PAGES_',
      infoEmpty:'Nessun record',
      zeroRecords:'Nessun risultato',
      infoFiltered:'(filtrati da _MAX_ totali)'
    }
  });
  const dtUnavail = $('#tbl-nondisponibili').DataTable({
    pageLength: 5,
    lengthChange: false,
    dom: 'lrtip',
    language: {
      paginate: { previous: '«', next: '»' },
      info:     'Pagina _PAGE_ di _PAGES_',
      infoEmpty:'Nessun record',
      zeroRecords:'Nessun risultato',
      infoFiltered:'(filtrati da _MAX_ totali)'
    }
  });

    // 2) Filtri lato client
    $('#filter-avail').on('keyup', function(){
      dtAvail.search(this.value).draw();
    });
    $('#filter-unavail').on('keyup', function(){
      dtUnavail.search(this.value).draw();
    });

    // 3) Bind degli switch
    $('.switch-inf').on('change', async function(){
      const row = $(this).closest('tr');
      const id  = row.data('id');
      const val = this.checked;
      try {
        // aggiorna il DB
        await fetch(`/anagrafica/${id}/infortunio`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ infortunio: val, data_rientro: null })
        });
        // sposta la riga tra le due tabelle
        if (val) {
          // da disponibili a non disponibili
          dtAvail.row(row).remove().draw();
          dtUnavail.row.add([
            `<div class="form-check form-switch">
               <input class="form-check-input switch-inf" type="checkbox" checked>
             </div>`,
            row.find('td:eq(1)').html()
          ]).draw();
        } else {
          // da non disponibili a disponibili
          dtUnavail.row(row).remove().draw();
          dtAvail.row.add([
            `<div class="form-check form-switch">
               <input class="form-check-input switch-inf" type="checkbox">
             </div>`,
            row.find('td:eq(1)').html()
          ]).draw();
        }
      } catch (e) {
        alert('Errore durante l’aggiornamento dello stato infortunio');
      }
    });
  });
</script>


