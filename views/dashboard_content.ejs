<h3>Benvenuto, <%= user %></h3>

<div class="mb-4">
  <label for="period-select" class="form-label me-2">Intervallo:</label>
  <select id="period-select" class="form-select w-auto d-inline-block">
    <option value="week">Ultima settimana</option>
    <option value="month" selected>Ultimo mese</option>
    <option value="year">Ultimo anno</option>
  </select>
</div>

<div class="row gy-4 mb-5">
  <!-- Distretto -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Distretti (terapie)</h5>
        <canvas id="chart-distretti"></canvas>
      </div>
    </div>
  </div>
  <!-- Trattamenti -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Trattamenti</h5>
        <canvas id="chart-trattamenti"></canvas>
      </div>
    </div>
  </div>
  <!-- Operatori -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Operatori</h5>
        <canvas id="chart-operatori"></canvas>
      </div>
    </div>
  </div>
  <!-- Giocatori -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Giocatori</h5>
        <canvas id="chart-giocatori"></canvas>
      </div>
    </div>
  </div>
</div>

<hr>

<div class="mb-4">
  <h4>Giocatori Disponibili</h4>
  <input id="filter-avail" placeholder="Filtra per nome/cognome" class="form-control w-25 mb-2" />
  <table id="tbl-disponibili" class="table table-striped">
    <thead>
      <tr>
        <th>Infortunato</th>
        <th>Nome Cognome</th>
      </tr>
    </thead>
    <tbody>
      <% disponibili.forEach(p => { %>
      <tr data-id="<%= p.id %>">
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input switch-inf" type="checkbox"
                   <%= p.infortunio ? 'checked' : '' %> />
          </div>
        </td>
        <td><%= p.nome %> <%= p.cognome %></td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="mb-4">
  <h4>Giocatori Non Disponibili</h4>
  <input id="filter-unavail" placeholder="Filtra per nome/cognome" class="form-control w-25 mb-2" />
  <table id="tbl-nondisponibili" class="table table-striped">
    <thead>
      <tr>
        <th>Infortunato</th>
        <th>Nome Cognome</th>
      </tr>
    </thead>
    <tbody>
      <% nondisponibili.forEach(p => { %>
      <tr data-id="<%= p.id %>">
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input switch-inf" type="checkbox"
                   <%= p.infortunio ? 'checked' : '' %> />
          </div>
        </td>
        <td><%= p.nome %> <%= p.cognome %></td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script>
  // Inizializza DataTables
  $('#table-avail').DataTable({ pageLength: 5, lengthChange: false });
  $('#table-unavail').DataTable({ pageLength: 5, lengthChange: false });

  // filtri custom
  $('#filter-avail').on('keyup', function(){ $('#table-avail').DataTable().search(this.value).draw(); });
  $('#filter-unavail').on('keyup', function(){ $('#table-unavail').DataTable().search(this.value).draw(); });

  // switch edit inline
  $('.switch-inf').each(function(){
    const row = $(this).closest('tr');
    const id = row.data('id');
    $(this).on('change', async function(){
      const val = this.checked;
      try {
        await fetch(`/anagrafica/${id}/infortunio`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ infortunio: val, data_rientro: null })
        });
        // sposta riga tra tabelle
        const dtSrc = val ? '#table-avail' : '#table-unavail';
        const dtDst = val ? '#table-unavail' : '#table-avail';
        var data = $(row).find('td').map((i,td)=>$(td).html()).get();
        // rimuovi da src e aggiungi a dst
        var srcT = $(dtSrc).DataTable(); srcT.row(row).remove().draw();
        var dstT = $(dtDst).DataTable(); dstT.row.add(data).draw();
      } catch(e) { alert('Errore'); }
    });
  });
</script>

<script>
  $(document).ready(function(){
    $('#tbl-disponibili, #tbl-nondisponibili').DataTable({
      pageLength: 5,
      lengthChange: false,
      language: {
        paginate: { previous: '«', next: '»' },
        info:     'Pagina _PAGE_ di _PAGES_',
        infoEmpty:'Nessun record',
        zeroRecords:'Nessun risultato',
        infoFiltered:'(filtrati da _MAX_ totali)'
      }
    });
  });
</script>

