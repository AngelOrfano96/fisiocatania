<h3>Benvenuto, <%= user %></h3>

<div class="mb-4">
  <label for="period-select" class="form-label me-2">Intervallo:</label>
  <select id="period-select" class="form-select w-auto d-inline-block">
    <option value="week">Ultima settimana</option>
    <option value="month" selected>Ultimo mese</option>
    <option value="year">Ultimo anno</option>
  </select>
</div>

<div class="row gy-4 mb-5">
  <!-- Distretto -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Distretti (terapie)</h5>
        <canvas id="chart-distretti"></canvas>
      </div>
    </div>
  </div>
  <!-- Trattamenti -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Trattamenti</h5>
        <canvas id="chart-trattamenti"></canvas>
      </div>
    </div>
  </div>
  <!-- Operatori -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Operatori</h5>
        <canvas id="chart-operatori"></canvas>
      </div>
    </div>
  </div>
  <!-- Giocatori -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Giocatori</h5>
        <canvas id="chart-giocatori"></canvas>
      </div>
    </div>
  </div>
</div>

<hr>

<hr>

<h3>Giocatori Disponibili</h3>
<div class="input-group mb-2 w-50">
  <input id="filter-avail" type="text" class="form-control" placeholder="Filtra per nome/cognome">
  <button id="btn-search-avail" class="btn btn-outline-secondary">Cerca</button>
</div>
<table id="tbl-disponibili" class="table table-striped">
  <thead>
    <tr>
      <th>Infortunato</th>
      <th>Nome Cognome</th>
    </tr>
  </thead>
  <tbody>
    <% disponibili.forEach(p => { %>
      <tr data-id="<%= p.id %>">
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input switch-inf" type="checkbox"
                   <%= p.infortunio ? 'checked' : '' %> />
          </div>
        </td>
        <td><%= p.nome %> <%= p.cognome %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

<hr>

<h3>Giocatori Non Disponibili</h3>
<div class="input-group mb-2 w-50">
  <input id="filter-unavail" type="text" class="form-control" placeholder="Filtra per nome/cognome">
  <button id="btn-search-unavail" class="btn btn-outline-secondary">Cerca</button>
</div>
<table id="tbl-nondisponibili" class="table table-striped">
  <thead>
    <tr>
      <th>Infortunato</th>
      <th>Nome Cognome</th>
    </tr>
  </thead>
  <tbody>
    <% nondisponibili.forEach(p => { %>
      <tr data-id="<%= p.id %>">
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input switch-inf" type="checkbox"
                   <%= p.infortunio ? 'checked' : '' %> />
          </div>
        </td>
        <td><%= p.nome %> <%= p.cognome %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

<script>
  window.addEventListener('load', function () {
    // 1) Inizializza DataTables con 5 righe per pagina
    const dtDisp = $('#tbl-disponibili').DataTable({
      pageLength: 5,
      lengthChange: false,
      dom: 'lrtip',
      language: {
        paginate: { previous: '«', next: '»' },
        info:     'Pagina _PAGE_ di _PAGES_',
        infoEmpty:'Nessun record',
        zeroRecords:'Nessun risultato',
        infoFiltered:'(filtrati da _MAX_ totali)'
      }
    });

    const dtNon = $('#tbl-nondisponibili').DataTable({
      pageLength: 5,
      lengthChange: false,
      dom: 'lrtip',
      language: {
        paginate: { previous: '«', next: '»' },
        info:     'Pagina _PAGE_ di _PAGES_',
        infoEmpty:'Nessun record',
        zeroRecords:'Nessun risultato',
        infoFiltered:'(filtrati da _MAX_ totali)'
      }
    });

    // 2) Filtri "Cerca"
    document.getElementById('btn-search-avail').addEventListener('click', () => {
      dtDisp.search(document.getElementById('filter-avail').value).draw();
    });
    document.getElementById('btn-search-unavail').addEventListener('click', () => {
      dtNon.search(document.getElementById('filter-unavail').value).draw();
    });

    // 3) Delego evento sugli switch per spostare le righe tra le due tabelle
    $('#tbl-disponibili, #tbl-nondisponibili').on('change', '.switch-inf', async function(){
      const $row = $(this).closest('tr');
      const id   = $row.data('id');
      const val  = this.checked;

      try {
        await fetch(`/anagrafica/${id}/infortunio`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ infortunio: val, data_rientro: null })
        });

        if (val) {
          // da disponibili → non disponibili
          dtDisp.row($row).remove().draw();
          dtNon.row.add([
            `<div class="form-check form-switch"><input class="form-check-input switch-inf" type="checkbox" checked></div>`,
            $row.find('td:eq(1)').html()
          ]).draw();
        } else {
          // da non disponibili → disponibili
          dtNon.row($row).remove().draw();
          dtDisp.row.add([
            `<div class="form-check form-switch"><input class="form-check-input switch-inf" type="checkbox"></div>`,
            $row.find('td:eq(1)').html()
          ]).draw();
        }
      } catch {
        alert('Errore durante l’aggiornamento dello stato infortunio');
      }
    });
  });
</script>




