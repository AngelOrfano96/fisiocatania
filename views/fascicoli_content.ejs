<h3>Fascicoli</h3>

<% if (typeof message !== 'undefined' && message) { %>
  <div class="alert alert-danger"><%= message %></div>
<% } %>

<form method="GET" action="/fascicoli" class="row g-2 mb-4">
  <div class="col-md-5">
    <input
      type="text"
      name="cognome"
      class="form-control"
      placeholder="Filtra per Cognome"
      value="<%= filters.cognome %>"
    >
  </div>
  <div class="col-md-5">
    <input
      type="text"
      name="nome"
      class="form-control"
      placeholder="Filtra per Nome"
      value="<%= filters.nome %>"
    >
  </div>
  <div class="col-md-2 text-end">
    <button class="btn btn-primary w-100">Filtra</button>
  </div>
</form>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Foto</th>
      <th>Anagrafica</th>
      <th>Data Nascita</th>
      <th>Comune</th>
      <th>Cellulare</th>
      <th>Fascicolo</th>
    </tr>
  </thead>
  <tbody>
    <% anagrafiche.forEach(a => { %>
      <tr>
        <td>
          <% 
            // Se c‚Äô√® un URL in a.foto lo uso, altrimenti il default
            const fotoSrc = a.foto || defaultPhoto;
            // Estraggo YYYY-MM-DD dalla stringa
            const dataDisplay = typeof a.data_nascita === 'string'
              ? a.data_nascita.slice(0,10)
              : '';
          %>
          <img
            src="<%= fotoSrc %>"
            alt="Foto di <%= a.nome %> <%= a.cognome %>"
            class="img-thumbnail"
            style="width:60px; height:60px; object-fit:cover;"
            onerror="this.onerror=null; this.src='<%= defaultPhoto %>'"
          >
        </td>
        <td><%= a.nome %> <%= a.cognome %></td>
        <td><%= dataDisplay %></td>
        <td><%= a.luogo_nascita %></td>
        <td><%= a.cellulare %></td>
        <td>
          <button
            type="button"
            class="btn btn-sm btn-info btn-view"
            data-id="<%= a.id %>"
          >üëÅÔ∏è</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<div id="fascicolo-detail" class="mt-4"></div>

<script>
  // Funzione per attivare il photo‚Äëeditor nel dettaglio
  function initPhotoEditor() {
    const btnEdit   = document.querySelector('#fascicolo-detail #btn-edit-photo');
    if (!btnEdit) return; // non siamo in un dettaglio
    const btnSave   = document.getElementById('btn-save-photo');
    const btnCancel = document.getElementById('btn-cancel-photo');
    const inputFile = document.getElementById('foto-input');
    const imgPreview= document.getElementById('profile-img');

    btnEdit.addEventListener('click', () => {
      inputFile.classList.remove('d-none');
      btnEdit.classList.add('d-none');
      btnSave.classList.remove('d-none');
      btnCancel.classList.remove('d-none');
    });
    btnCancel.addEventListener('click', () => {
      inputFile.value = '';
      inputFile.classList.add('d-none');
      btnEdit.classList.remove('d-none');
      btnSave.classList.add('d-none');
      btnCancel.classList.add('d-none');
      // ripristino preview
      imgPreview.src = imgPreview.getAttribute('src');
    });
    inputFile.addEventListener('change', () => {
      const file = inputFile.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => imgPreview.src = e.target.result;
      reader.readAsDataURL(file);
    });
  }

  // Attacco i listener sui pulsanti ‚ÄúüëÅÔ∏è‚Äù **dopo** che il DOM √® pronto
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-view').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (!id) return alert('ID non valido per questa anagrafica');
        fetch(`/fascicoli/${id}`)
          .then(res => {
            if (!res.ok) throw new Error('Errore nel caricamento del fascicolo');
            return res.text();
          })
          .then(html => {
            const container = document.getElementById('fascicolo-detail');
            container.innerHTML = html;
            initPhotoEditor();
          })
          .catch(err => alert(err.message));
      });
    });
  });
</script>
