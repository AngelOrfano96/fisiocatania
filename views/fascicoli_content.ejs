<h3>Fascicoli</h3>

<% if (message) { %>
  <div class="alert alert-danger"><%= message %></div>
<% } %>

<form method="GET" action="/fascicoli" class="row g-2 mb-4">
  <div class="col-md-5">
    <input
      type="text"
      name="cognome"
      class="form-control"
      placeholder="Filtra per Cognome"
      value="<%= filters.cognome %>"
    >
  </div>
  <div class="col-md-5">
    <input
      type="text"
      name="nome"
      class="form-control"
      placeholder="Filtra per Nome"
      value="<%= filters.nome %>"
    >
  </div>
  <div class="col-md-2 text-end">
    <button class="btn btn-primary w-100">Filtra</button>
  </div>
</form>

<table id="fascicoli-table" class="table table-striped">
  <thead>
    <tr>
      <th>Foto</th>
      <th>Anagrafica</th>
      <th>Data Nascita</th>
      <th>Comune</th>
      <th>Cellulare</th>
      <th>Fascicolo</th>
    </tr>
  </thead>
  <tbody>
    <% anagrafiche.forEach(a => {
         const fotoSrc = a.foto || defaultPhoto;
         const dataDisplay = typeof a.data_nascita === 'string'
           ? a.data_nascita.slice(0,10)
           : '';
    %>
    <tr>
      <td>
        <img
          src="<%= fotoSrc %>"
          alt="Foto di <%= a.nome %> <%= a.cognome %>"
          class="img-thumbnail"
          style="width:60px; height:60px; object-fit:cover;"
          onerror="this.onerror=null; this.src='<%= defaultPhoto %>'"
        >
      </td>
      <td><%= a.nome %> <%= a.cognome %></td>
      <td><%= dataDisplay %></td>
      <td><%= a.luogo_nascita %></td>
      <td><%= a.cellulare %></td>
      <td>
        <button
          type="button"
          class="btn btn-sm btn-info"
          onclick="caricaFascicolo(<%= a.id %>)"
        >üëÅÔ∏è</button>
      </td>
    </tr>
    <% }) %>
  </tbody>
</table>

<div id="fascicolo-detail" class="mt-4"></div>

<!-- Inizia qui gli script: assicurati che jQuery e DataTables siano gi√† stati caricati nel layout -->
<script>
  // 1) Inizializza la DataTable
  $(function() {
    $('#fascicoli-table').DataTable({
      pageLength: 4,
      lengthChange: false,
      language: {
        paginate: { previous: '¬´', next: '¬ª' },
        info: 'Pagina _PAGE_ di _PAGES_',
        zeroRecords: 'Nessun risultato',
        infoEmpty: 'Nessun record',
        infoFiltered: '(filtrati da _MAX_ totali)'
      }
    });
  });

  // 2) AJAX per caricare il dettaglio
  async function caricaFascicolo(id) {
    if (!id || isNaN(id)) {
      return alert('ID non valido: ' + id);
    }
    try {
      const res  = await fetch(`/fascicoli/${id}`);
      if (!res.ok) throw new Error('Errore nel caricamento del fascicolo');
      const html = await res.text();
      document.getElementById('fascicolo-detail').innerHTML = html;
     initPhotoEditor();
     // Una volta iniettato il partial, aggancio il photo-editor
     if (typeof initPhotoEditor === 'function') {
       initPhotoEditor();
     } else {
       console.error('initPhotoEditor non definita');
     }
    } catch (err) {
      alert(err.message);
    }
  }


</script>
